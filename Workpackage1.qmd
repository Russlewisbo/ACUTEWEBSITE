---
title: "Workpackage 1"
date: "10/20/2022"
format: 
  html:
    code-fold: true
execute:
  echo: true
  warning: false
bibliography: references.bib
csl: nature.csl
---

## Package 1A

**Establishing the quantitative relationship of Tpos and KPC-*Klebsiella pneumoniae* inoculum in blood culture bottles.** <br> The methods for the assay are a modification of those originally proposed by Kaltsas et al.[@kaltsas2005] Detailed procedures can be found at this [link](Protocols.html). Methodology for preparing the test inoculum was adapted from [CLSI M21A](CLSI_M21A.pdf) and [M26A](CLSI_M26A.pdf) guidelines.[@Clinical_Laboratory_Standards_Institute1999-iy; @Clinical_Laboratory_Standards_Institute1999-iya]

-   Briefly, tubes containing 1.8 mL of pooled healthy human serum were inoculated with 0.2 mL of a series of ten-fold dilutions (5x10^1^ to 5x10^7^ CFU/mL) of the standardised inoculum of each test indicator strains.
-   The inoculated sera were then transferred into BacT⁄ALERT bottles without inactivating matrix (Biomérieux Inc) for aerobic incubation for 24 hours and monitored for time to positivity.
-   Tpos results were used to establish preliminary assay quality control ranges by testing in triplicate for five KPC-carbapenemase producing *K. pneumoniae* strains (KPC_KPCA,B,C and NDM, and VIM producing strains) and a reference *K. pneumoniae* ATCC strain producing ESBL enzyme only.
-   Detailed information on the isolates can be found [here](Protocols.html). We also compared how inoculation of the organism suspension prepared in phosphate buffered saline (PBS-0.9%) versus pooled human serum (serum) affected Tpos.

Figure 1 shows the relationship between Tpos and the *K. pneumoniae* inoculum. A linear relationship was observed from approximately 10^1^-10^8^ *K. pneumoniae* CFU/mL and a Tpos measured from 10.5 hours-4.5 hours over the tested inoculum range, with R^2^ of 0.92-0.94.

*These data confirm that Tpos exhibits a wide dynamic range as a surrogate indicator for viable CFU/mL.*

::: callout-note
In the original methodology proposed by Kaltsas et al, [@kaltsas2005] the isolate inoculum was reported as the inoculum introduced into the bottle that already contains between 30-40 mL of growth media (depending on the manufacturer).

We have opted to report the final inoculum in each bottle accounting for the growth media dilution effect.

All experiments were performed using bloodculture bottles ***without antibiotic inactivating matrix***
:::

### Figure 1. Tpos vs. test inoculum

```{r}
library (ggplot2)
library(scales)
theme_set(theme_bw())
## import raw data from .csv file
wp1 <- read.csv("~/Desktop/ACUTEWEBSITE/wp1a.csv")
## plot raw data as x-y graph Tpos graph vs. drug concentrations stratified by dilution matrix, method="lm" is the method for linear regression
fig1 <-ggplot(wp1, aes(x=inoculum_adj, y=tpos, color=isolates, shape=diluent, fill=isolates)) + geom_point(size=4, alpha = 0.5) + 
scale_y_continuous(name="Tpos (hr)", limits=c(4,12)) +
theme(legend.text=element_text(size=12)) +
geom_smooth(aes(linetype=diluent), method=lm , color="black", fill="#69b3a2", se=TRUE, inherit.aes = TRUE )
fig1 + theme_bw(base_size = 14)+ scale_x_log10(name="Inoculum CFU/mL", breaks = trans_breaks("log10",n=7, function(x) 10^x),labels = trans_format("log10", math_format(10^.x)))

```

```{r}
## use forestmangr package to output results of linear regression in Kable-table for display in webpage
library(forestmangr)
library(kableExtra)
wp1 <- read.csv("~/Desktop/ACUTEWEBSITE/wp1a.csv")
df <- data.frame (wp1)
table1<-lm_table(df, log(inoculum) ~ tpos, "diluent")
kbl(table1)%>%
kable_paper("hover", full_width = F, position="left")
```

## Package 1B: Effect of ceftazidime/avibactam exposure on Tpos

This workpackage explores how antibiotic concentrations impact Tpos. <br>

The effect of increasing fixed ceftazidime/avibactam (CAZ/AVI) concentrations (4:1) on Tpos was investigated at an inoculum of 1x10^4^ CFU/mL of *K. pneumoniae* KPC_B (MIC 1 mg/L) and *K. pneumoniae* NDM producing isolate (negative control, MIC \> 64 mg/L ). All experiments were performed in \> 5 replicates with an incubation period of 24 hours. Figure 2 shows a marked increased in the Tpos for KPC_B from \< 10 hrs to [\>]{.underline} 24 hrs when CAZ/AVI concentrations surpassed 1 mg/L. In contrast, the negative control KPC_NDM strain exhibited consistent Tpos \< 10hr at all test concentrations with lack of antimicrobial activity. Trends in growth patterns are indicated by Loess.

::: callout-note
Drug concentrations reported in figures represent the concentration of antibiotic injected (1 mL) into the bottle- "simulating" the antibiotic concentrations that would be detected in the bloodstream. These concentrations do not account for 40 mL growth median and inoculum (1 mL) already present in the bottle= total volume 42 mL.
:::

### Figure 2. Impact of CAZ/AVI concentrations on Tpos

```{r}
## simple x-y plot of raw data to show Tpos differences for susceptible versus intrinsically resistant isolate. Trends are highlighted by loess
library (ggplot2)
theme_set(theme_bw())
ceftaz <- read.csv("~/Desktop/ACUTEWEBSITE/datasets/ceftazidime.csv")
ggplot(ceftaz, aes(x=conc, y=tpos, color=isolate, shape=isolate)) + 
  geom_point(size=4, alpha = 0.7)+ 
  geom_smooth(aes(linetype=isolate), method= loess, color="black", fill="#69b3a2", se=TRUE, inherit.aes = TRUE ) +
scale_x_log10(name="CAZ/AVI, mg/L") +
scale_y_continuous(name="Tpos (hr)", limits=c(4,25)) 

```

<br>

<br>

### Figure 3. In vitro pharmacodynamics of CAZ/AVI concentrations vs. Tpos (KPC_B isolate MIC 1 mg/L)

The relationship between[@drda]

::: callout-note
Experiments shown below were performed using commercial CAZ/AVI formulation not analytical powder
:::

```{r}
## a four-parameter logistic regression model is fit to ceftazidime concencentrations to estiamted PD parameters
library (readxl)
library(drda)
caz_avi_4 <- read_excel("datasets/kpcb_caz_avi_com.xlsx")
fit1 <- drda(tpos ~ ctz, data=caz_avi_4, mean_function = "loglogistic4", max_iter = 1000)
plot(fit1, xlab = "CAZ/AVI Serum (mg/L)", ylab = "Tpos (hr)")
```

```{r}
## Analysis is repeated to produce a table reporting estimated EC10-EC95 parametersestiamtes plus 95% CI 
library (readxl)
library(drda)
library(broom)
library(kableExtra)
caz_avi_4 <- read_excel("datasets/kpcb_caz_avi_com.xlsx")
fit1 <- drda(tpos ~ ctz, data=caz_avi_4, mean_function = "loglogistic4", max_iter = 1000)
ed<-effective_dose(fit1, y = c(0.10,0.25,0.50,0.75,0.90,0.95))
kbl(ed)%>%
kable_paper("hover", full_width = F, position = "left")
```

### Figure 4. In vitro pharmacodynamics of CAZ/AVI concentrations vs. Tpos (KPC_B isolate MIC 1 mg/L)

::: callout-note
Experiments performed using pure powder at a CAZ:AVI ratio of 4:1
:::

```{r}
## a four-parameter logistic regression model is fit to ceftazidime concencentrations to estiamted PD parameters
library (readxl)
library(drda)
caz_avi_5 <- read_excel("datasets/kpcb_caz_avi_powder_4-1.xlsx")
fit2 <- drda(tpos ~ ctz, data=caz_avi_5, mean_function = "loglogistic4", max_iter = 1000)
plot(fit2, xlab = "CAZ/AVI Serum (mg/L)", ylab = "Tpos (hr)")
```

```{r}
## Analysis is repeated to produce a table reporting estimated EC10-EC95 parametersestiamtes plus 95% CI 
library (readxl)
library(drda)
library(broom)
library(kableExtra)
caz_avi_5 <- read_excel("datasets/kpcb_caz_avi_powder_4-1.xlsx")
fit2 <- drda(tpos ~ ctz, data=caz_avi_5, mean_function = "loglogistic4", max_iter = 1000)
ed<-effective_dose(fit2, y = c(0.10,0.25,0.50,0.75,0.90,0.95))
kbl(ed)%>%
kable_paper("hover", full_width = F, position = "left")
```

### Figure 5. In vitro pharmacodynamics of CAZ/AVI concentrations vs. Tpos (KPC_A isolate MIC 2 mg/L)

::: callout-note
Experiments performed using the commercial CAZ/AVI formulation.
:::

```{r}
## a four-parameter logistic regression model is fit to ceftazidime concencentrations to estiamted PD parameters
library (readxl)
library(drda)
caz_avi_6 <- read_excel("datasets/kpca_caz_avi_com.xlsx")
fit3 <- drda(tpos ~ ctz, data=caz_avi_6, mean_function = "loglogistic4", max_iter = 1000)
plot(fit3, xlab = "CAZ/AVI Serum (mg/L)", ylab = "Tpos (hr)")

```

```{r}
## Analysis is repeated to produce a table reporting estimated EC10-EC95 parametersestiamtes plus 95% CI 
library (readxl)
library(drda)
library(broom)
library(kableExtra)
caz_avi_6 <- read_excel("datasets/kpca_caz_avi_com.xlsx")
fit3 <- drda(tpos ~ ctz, data=caz_avi_6, mean_function = "loglogistic4", max_iter = 1000)
ed<-effective_dose(fit3, y = c(0.10,0.25,0.50,0.75,0.90,0.95))
kbl(ed)%>%
kable_paper("hover", full_width = F, position = "left")
```

### Figure 6. In vitro pharmacodynamics of CAZ/AVI concentrations vs. Tpos (KPC_A isolate MIC 2 mg/L)

::: callout-note
Experiments performed using pure powder with a ceftazidime:avibactam ratio of 4:1
:::

```{r}
## a four-parameter logistic regression model is fit to ceftazidime concencentrations to estiamted PD parameters
library (readxl)
library(drda)
caz_avi_7 <- read_excel("datasets/kpca_caz_avi_powder_4-1.xlsx")
fit4 <- drda(tpos ~ ctz, data=caz_avi_7, mean_function = "loglogistic4", max_iter = 1000)
plot(fit4, xlab = "CAZ/AVI Serum (mg/L)", ylab = "Tpos (hr)")

```

```{r}
## Analysis is repeated to produce a table reporting estimated EC10-EC95 parametersestiamtes plus 95% CI 
library (readxl)
library(drda)
library(broom)
library(kableExtra)
caz_avi_7 <- read_excel("datasets/kpca_caz_avi_powder_4-1.xlsx")
fit4 <- drda(tpos ~ ctz, data=caz_avi_7, mean_function = "loglogistic4", max_iter = 1000)
ed<-effective_dose(fit4, y = c(0.10,0.25,0.50,0.75,0.90,0.95))
kbl(ed)%>%
kable_paper("hover", full_width = F, position = "left")
```

### Figure 7. In vitro pharmacodynamics of CAZ/AVI concentrations vs. Tpos (KPC_A isolate MIC 2 mg/L)

::: callout-note
Experiments were repeated using pure powder but with a fixed concentration of avibactam at 4 mg/L in all tubes
:::

```{r}
## a four-parameter logistic regression model is fit to ceftazidime concencentrations to estiamted PD parameters
library (readxl)
library(drda)
caz_avi_8 <- read_excel("datasets/kpca_caz_avi_powder_fix4.xlsx")
fit5<- drda(tpos ~ ctz, data=caz_avi_8, mean_function = "loglogistic4", max_iter = 1000)
plot(fit5, xlab = "CAZ/AVI Serum (mg/L)", ylab = "Tpos (hr)")

```

```{r}
## Analysis is repeated to produce a table reporting estimated EC10-EC95 parametersestiamtes plus 95% CI 
library (readxl)
library(drda)
library(broom)
library(kableExtra)
caz_avi_8 <- read_excel("datasets/kpca_caz_avi_powder_fix4.xlsx")
fit5 <- drda(tpos ~ ctz, data=caz_avi_8, mean_function = "loglogistic4", max_iter = 1000)
ed<-effective_dose(fit5, y = c(0.10,0.25,0.50,0.75,0.90,0.95))
kbl(ed)%>%
kable_paper("hover", full_width = F, position = "left")
```

------------------------------------------------------------------------

## Package 1B: Effect of combination antimicrobial exposure on Tpos

### Figure 8. In vitro effects of combination ceftazidime/avibactam + gentamicin

-   The activity of combination ceftazidime/avibactam (4 to 1 ratio from commercial formulation) plus gentamicin was tested against *Klebsiella pneumonia*\_KPC_B strain in 3 replicate experiments.
-   The effect of the Tpos combination was analyzed using a Bliss Independence Model of drug interaction using a workflow described for the [synergy analysis](https://cran.r-project.org/web/packages/BIGL/vignettes/analysis.html) using the BIGL package.[@BIGL]
-   The results demonstrated that CTZ/AVI + gentamicin is broadly synergistic over a range of clinically achieved concentrations, with and average 4.29 hr increase (95% CI 2.65-6.46) in Tpos versus the predicted null interactive response of ceftazidime-avibactam and gentamicin alone.

```{r}
library(BIGL)
library(knitr)
library(rgl)
library(ggplot2)
library(broom)
library(kableExtra)
set.seed(12345)
cutoff <- 0.95
caz_gent <- read.csv("~/Desktop/ACUTEWEBSITE/datasets/caz_gent_syn.csv")
## Fitting marginal models, maximal fixed at 24 hours, minimal at 9 hours
marginalFit <- fitMarginals(caz_gent, method = "optim",                 
                            fixed = c("m1" = 24, "m2" = 24, "b" = 9),
                            names = c("CTZ/AVI", "GENT"))
summary(marginalFit)
## Plotting marginal model for ceftazidime and gentamicin, minimum constrained at 9 hrs and maximum contrastined at 24 hours
plot(marginalFit) + ggtitle(paste("Ceftazidime/Avibactam + Gentamicin"))
rs <- fitSurface(caz_gent, marginalFit,
                 null_model = "bliss",
                 B.CP = 50, statistic = "none", parallel = FALSE)
summary(rs)
plot(rs, legend = FALSE, main = "")
view3d(0, -75)
rglwidget()


## mean R statistic evaluates how the test evaluates how the predicted response surface based on a specified null model differs from the observed one. If the null hypothesis is rejected, this test suggests that at least some dose combinations may exhibit synergistic or antagonistic behaviour. The meanR test is not designed to pinpoint which combinations produce these effects nor what type of deviating effect is present.
meanR_N <-fitSurface(caz_gent, marginalFit, statistic="meanR",CP=rs$CP, B.B=20, parallel = FALSE)

# maxR test allows to evaluate presence of synergistic/antagonistic effects for each dose combination and as such provides a point-by-point classification.
maxR_N <- fitSurface(caz_gent, marginalFit,
                     statistic = "maxR", CP = rs$CP, B.B = 20,
                     parallel = FALSE)
maxR_B <- fitSurface(caz_gent, marginalFit,
                     statistic = "maxR", CP = rs$CP, B.B = 20,
                     parallel = FALSE)
maxR_both <- rbind(summary(maxR_N$maxR)$totals,
                   summary(maxR_B$maxR)$totals)

contour(maxR_B,
         ## colorPalette = c("blue", "black", "black", "red"),
        main = paste0(" Ceftazidime/Avibactam + Gentamicin"),
        scientific = TRUE, digits = 3, cutoff = cutoff)

plotConfInt(maxR_B, color ="effect-size")

rsh <- fitSurface(caz_gent, marginalFit,
                  null_model = "hsa",
                  B.CP = 50, statistic = "both", parallel = FALSE)
summary(rsh)

rsb <- fitSurface(caz_gent, marginalFit, 
                  null_model = "bliss",
                  B.CP = 50, statistic = "both", parallel = FALSE)
summary(rsb)





```

### Figure 9. In vitro effects of combination ceftazidime/avibactam + aztreonam against NDM-1 producing isolate.

-   The activity of combination ceftazidime/avibactam (4 to 1 ratio from commercial product) plus aztreonam (1.25-40 mg/L) was tested against and NDM-2 producing *Klebsiella pneumoniae* isolate (ceftazidime/avibactam MIC \> 64 mg/L).
-   The effect of the Tpos combination was analyzed using a Bliss Independence Model of Drug interaction.
-   The results demonstrated that CTZ/AVI + aztreonam is broadly synergistic over a range of clinically achieved concentrations, **with an average 8.544 hr (95% CI 8.46-8.60) increase in Tpos versus the predicted null response for each individual drug.**

```{r}
library(BIGL)
library(knitr)
library(rgl)
library(ggplot2)
library(broom)
library(kableExtra)
set.seed(12345)
cutoff <- 0.95
caz_azt <- read.csv("~/Desktop/ACUTEWEBSITE/datasets/caz_avi_azt.csv")
## Fitting marginal models, maximal fixed at 24 hours, minimal at 8.5 hours
marginalFit2 <- fitMarginals(caz_azt, method = "optim",                 
                            fixed = c("m1" = 24, "m2" = 24, "b" = 9),
                            names = c("CTZ/AVI", "AZT"))
summary(marginalFit)
## Plotting marginal model for ceftazidime/avibactam and aztroenam, minimum constrained at 9 hrs and maximum constrained at 24 hours
plot(marginalFit2) + ggtitle(paste("Ceftazidime/Avibactam + Aztreonam"))
rs2 <- fitSurface(caz_azt, marginalFit2,
                 null_model = "bliss",
                 B.CP = 50, statistic = "none", parallel = FALSE)
summary(rs2)
plot(rs2, legend = FALSE, main = "")
view3d(0, -75)
rglwidget()

```
